<template>
  <q-page padding>

    <q-dialog v-model="visible" persistent>
      <q-card class="full-width">
        <q-form @submit="onSubmit">
          <q-card-section>
            <div class="text-h6">{{ $t('page.scripts') }}</div>
          </q-card-section>

          <q-card-section style="max-height: 70vh;" class="scroll">
            <div class="row q-col-gutter-x-md">
              <q-input outlined dense v-model="form.version" :label="$t('label.version')" class="col-6" />
              <q-input outlined dense v-model="form.type" :label="$t('label.type')" class="col-6" />
            </div>

            <q-input outlined dense v-model="form.body" :label="$t('label.body')" type="textarea" class="q-my-md"
              autogrow />
          </q-card-section>

          <q-card-actions align="right">
            <q-btn title="cancel" type="reset" unelevated :label="$t('action.cancel')" v-close-popup />
            <q-btn title="submit" type="submit" flat :label="$t('action.submit')" color="primary" />
          </q-card-actions>

        </q-form>
      </q-card>
    </q-dialog>

    <q-card flat>
      <q-card-section>
        <q-list v-if="rows && rows.length > 0">
          <q-expansion-item v-for="(items, group) in groupByKey(rows, 'type')" :key="group" expand-separator
            icon="sym_r_database" :label="group as string">
            <div v-if="items && items.length > 0" class="row q-col-gutter-md q-pb-md">
              <div class="col-xs-6 col-sm-4 col-md-3" v-for="(item, index) in items" :key="index"
                @click="showRow(item.id!)">
                <q-card flat bordered class="text-center cursor-pointer">
                  <q-img fit="none" :src="item.icon" style="height: 48px; max-width: 48px" class="q-mt-md" />
                  <q-card-section>
                    <div class="text-h6">{{ item.name }}: {{ item.version }}</div>
                    <p class="q-my-xs text-xs text-caption">
                      Updated Time: {{ date.formatDate(item.lastModifiedDate, 'YYYY-MM-DD HH:mm') }}
                    </p>
                  </q-card-section>
                </q-card>
              </div>
            </div>
          </q-expansion-item>
        </q-list>
      </q-card-section>
    </q-card>
  </q-page>
</template>

<script setup lang="ts">
import { date } from 'quasar'
import { retrieveDictionarySubset } from 'src/api/dictionaries'
import { fetchScript, retrieveScripts } from 'src/api/scripts'
import type { Dictionary, Script } from 'src/types'
import { groupByKey } from 'src/utils'
import { onMounted, ref } from 'vue'


const loading = ref<boolean>(false)
const visible = ref<boolean>(false)

const rows = ref<Array<Script>>([])
const scriptTypeOptions = ref<Array<Dictionary>>([])

const initialValues: Script = {
  id: null,
  name: '',
  icon: '',
  version: '',
  type: undefined,
  body: ''
}
const form = ref<Script>({ ...initialValues })

onMounted(async () => {
  await onRequest()

  const res = await retrieveDictionarySubset(68)
  scriptTypeOptions.value = res.data
})

function onSubmit() {
  // Close the dialog after submitting
  visible.value = false
}

/**
 * 加载列表
 */
async function onRequest() {
  loading.value = true
  try {
    const res = await retrieveScripts()
    rows.value = res.data
  } catch (error) {
    return Promise.resolve(error)
  } finally {
    loading.value = false
  }
}

/**
 * 加载
 * @param id 主键
 */
async function loadOne(id: number) {
  form.value = { ...initialValues }
  try {
    const res = await fetchScript(id)
    form.value = res.data
  } catch (error) {
    return Promise.resolve(error)
  }
}

async function showRow(id: number | undefined) {
  visible.value = true
  if (id) {
    await loadOne(id)
  }
}
</script>
