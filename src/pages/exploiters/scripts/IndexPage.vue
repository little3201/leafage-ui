<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import type { FormInstance, FormRules } from 'element-plus'
import { useI18n } from 'vue-i18n'
import { retrieveScripts, fetchScript, createScript, modifyScript } from 'src/api/scripts'
import { retrieveDictionarySubset } from 'src/api/dictionaries'
import type { Script, Dictionary } from 'src/types'
import { Icon } from '@iconify/vue'
import { groupByKey, hasAction } from 'src/utils'


const { t } = useI18n()

const loading = ref<boolean>(false)
const datas = ref<Array<Script>>([])
const scriptTypeOptions = ref<Array<Dictionary>>([])

const visible = ref<boolean>(false)
const previewVisible = ref<boolean>(false)

const formRef = ref<FormInstance>()
const initialValues: Script = {
  id: null,
  name: '',
  icon: '',
  version: '',
  type: undefined,
  body: ''
}
const form = ref<Script>({ ...initialValues })
const rules = reactive<FormRules<typeof form>>({
  name: [
    { required: true, message: t('placeholder.inputText', { field: t('label.name') }), trigger: 'blur' },
  ],
  type: [
    { required: true, message: t('placeholder.selectText', { field: t('label.type') }), trigger: 'blur' }
  ],
  version: [
    { required: true, message: t('placeholder.inputText', { field: t('label.category') }), trigger: 'blur' },
  ]
})

onMounted(async () => {
  await load()

  const res = await retrieveDictionarySubset(600)
  scriptTypeOptions.value = res.data
})

/**
 * 加载列表
 */
async function load() {
  try {
    const res = await retrieveScripts()
    datas.value = res.data
  } catch {
    return Promise.resolve()
  }
}

/**
 * 加载
 * @param id 主键
 */
async function loadOne(id: number) {
  form.value = { ...initialValues }
  try {
    const res = await fetchScript(id)
    form.value = res.data
  } catch {
    return Promise.resolve()
  }
}

/**
 * 详情
 * @param id 主键
 */
async function showRow(id: number | null) {
  if (id) {
    await loadOne(id)
  }
  previewVisible.value = true
}

async function saveRow(id?: number) {
  form.value = { ...initialValues }
  if (id) {
    await loadOne(id)
  }
  visible.value = true
}

async function onSubmit(formEl: FormInstance | undefined) {
  if (!formEl) return

  const valid = await formEl.validate()
  if (valid) {
    loading.value = true
    try {
      if (form.value.id) {
        await modifyScript(form.value.id, form.value)
      } else {
        await createScript(form.value)
      }
      visible.value = false
      await load()
    } catch {
      return Promise.resolve()
    } finally {
      loading.value = false
    }
  }
}
</script>

<template>
  <ElSpace size="large" fill class="w-full">
    <ElCard shadow="never">
      <ElRow :gutter="20" justify="space-between">
        <ElCol :span="16" class="text-left">
          <ElButton v-if="hasAction($route.name, 'create')" title="create" type="primary" @click="saveRow()">
            <Icon icon="material-symbols:add-rounded" width="1.25em" height="1.25em" />{{ $t('action.create') }}
          </ElButton>
        </ElCol>

        <ElCol :span="8" class="text-right">
          <ElTooltip class="box-item" effect="dark" :content="$t('action.refresh')" placement="top">
            <ElButton title="refresh" plain circle @click="load">
              <Icon icon="material-symbols:refresh-rounded" width="1.25em" height="1.25em" />
            </ElButton>
          </ElTooltip>
        </ElCol>
      </ElRow>
    </ElCard>

    <ElCard shadow="never">
      <ElCollapse v-if="datas && datas.length > 0">
        <ElCollapseItem v-for="(items, group) in groupByKey(datas, 'type')" :key="group" :title="group as string"
          :name="group">
          <div class="grid gap-4 mt-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
            <ElCard shadow="never" class="text-center cursor-pointer" v-for="item in items" :key="item.id"
              @click="showRow(item.id)" body-class="hover:bg-[var(--el-bg-color-page)]">
              <ElImage :src="item.icon" class="w-14 h-14" />
              <div>
                <p class="my-1 text-md text-(--el-text-color-regular)">
                  {{ item.name }}: {{ item.version }}
                </p>
              </div>
            </ElCard>
          </div>
        </ElCollapseItem>
      </ElCollapse>

      <ElEmpty v-else :image-size="300" />
    </ElCard>
  </ElSpace>

  <!-- form -->
  <ElDialog v-model="visible" :title="$t('page.scripts')" align-center :show-close="false" width="600">
    <ElForm ref="formRef" :model="form" :rules="rules" label-position="top">
      <ElRow :gutter="20">
        <ElCol :span="12">
          <ElFormItem :label="$t('label.name')" prop="name">
            <ElInput v-model="form.name" :placeholder="$t('placeholder.inputText', { field: $t('label.name') })" />
          </ElFormItem>
        </ElCol>
        <ElCol :span="6">
          <ElFormItem :label="$t('label.type')" prop="type">
            <ElSelect v-model="form.type">
              <ElOption v-for="item in scriptTypeOptions" :key="item.id" :label="item.name" :value="item.name" />
            </ElSelect>
          </ElFormItem>
        </ElCol>
        <ElCol :span="6">
          <ElFormItem :label="$t('label.category')" prop="version">
            <ElInput v-model="form.version"
              :placeholder="$t('placeholder.inputText', { field: $t('label.category') })" />
          </ElFormItem>
        </ElCol>
      </ElRow>
      <ElRow :gutter="20">
        <ElCol>
          <ElFormItem :label="$t('label.body')" prop="body">
            <ElInput v-model="form.body" type="textarea" :rows="22"
              :placeholder="$t('placeholder.inputText', { field: $t('label.body') })" />
          </ElFormItem>
        </ElCol>
      </ElRow>
    </ElForm>
    <template #footer>
      <ElButton title="cancel" @click="visible = false">
        <Icon icon="material-symbols:close" width="1.25em" height="1.25em" />{{ $t('action.cancel') }}
      </ElButton>
      <ElButton title="submit" type="primary" :loading="loading" @click="onSubmit(formRef)">
        <Icon icon="material-symbols:check-circle-outline-rounded" width="1.25em" height="1.25em" /> {{
          $t('action.submit') }}
      </ElButton>
    </template>
  </ElDialog>

  <!-- preview -->
  <ElDialog v-model="previewVisible" :title="$t('action.preview')" align-center>
    <p class="my-1 text-lg text-(--el-text-color-regular)">{{ form.name }}: {{ form.version }}</p>
    <CodeRender :content="form.body" />
  </ElDialog>
</template>
