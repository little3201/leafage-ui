<template>
  <q-form ref="formRef">
    <q-table flat :rows="fields" :columns="configColumns" row-key="id" binary-state-sort hide-pagination
      :pagination="{ rowsPerPage: 0 }" :loading="loading" class="full-width">
      <template v-slot:header="props">
        <q-tr :props="props">
          <q-th v-for="col in props.cols" :key="col.name" :props="props">
            {{ $t(`label.${col.label}`) }}
          </q-th>
        </q-tr>
      </template>

      <template v-slot:body-cell-dataType="props">
        <q-td :props="props">
          {{ props.row.dataType }}{{ props.row.length ? `(${props.row.length})` : '' }}
        </q-td>
      </template>
      <template v-slot:body-cell-nullable="props">
        <q-td :props="props">
          <q-badge :color="props.row.nullable ? 'positive' : 'primary'" rounded class="q-mr-sm" />
          {{ props.row.nullable ? 'Y' : 'N' }}
        </q-td>
      </template>
      <template v-slot:body-cell-unique="props">
        <q-td :props="props">
          <q-badge :color="props.row.unique ? 'positive' : 'warning'" rounded class="q-mr-sm" />
          {{ props.row.unique ? 'Y' : 'N' }}
        </q-td>
      </template>
      <template v-slot:body-cell-fieldType="props">
        <q-td :props="props">
          <q-select outlined dense options-dense v-model="props.row.fieldType" :options="fieldTypeOptions" emit-value
            option-value="name" option-label="name" style="width: 120px;" />
        </q-td>
      </template>
      <template v-slot:body-cell-formType="props">
        <q-td :props="props">
          <q-select outlined dense options-dense v-model="props.row.formType" :options="formTypeOptions" emit-value
            option-value="name" option-label="name" style="width: 120px;" />
        </q-td>
      </template>
      <template v-slot:body-cell-tsType="props">
        <q-td :props="props">
          <q-select outlined dense options-dense v-model="props.row.tsType" :options="tsTypeOptions" emit-value
            option-value="name" option-label="name" style="width: 120px;" />
        </q-td>
      </template>
      <template v-slot:body-cell-queryable="props">
        <q-td :props="props">
          <q-checkbox dense v-model="props.row.queryable" />
        </q-td>
      </template>
      <template v-slot:body-cell-queryType="props">
        <q-td :props="props">
          <q-select outlined dense options-dense v-model="props.row.queryType" :options="queryTypes"
            :disable="!props.row.queryable" style="width: 120px;" />
        </q-td>
      </template>
      <template v-slot:body-cell-editable="props">
        <q-td :props="props">
          <q-checkbox dense v-model="props.row.editable" />
        </q-td>
      </template>
      <template v-slot:body-cell-sortable="props">
        <q-td :props="props">
          <q-checkbox dense v-model="props.row.sortable" />
        </q-td>
      </template>
    </q-table>
  </q-form>
</template>

<script lang="ts" setup>
import type { QForm, QTableColumn } from 'quasar'
import { retrieveFields } from 'src/api/schemes'
import { queryTypes } from 'src/constants'
import type { Dictionary, Field } from 'src/types'
import { onMounted, ref } from 'vue'

const props = defineProps<{
  schemeId: number
  tableName: string
  fieldTypeOptions: Dictionary[]
  formTypeOptions: Dictionary[]
  tsTypeOptions: Dictionary[]
}>()

const loading = ref<boolean>(false)
const formRef = ref<QForm>()
const fields = ref<Array<Field>>([])

const configColumns: QTableColumn<Field>[] = [
  { name: 'name', label: 'name', align: 'left', field: 'name', sortable: true },
  { name: 'dataType', label: 'type', align: 'left', field: 'dataType' },
  { name: 'nullable', label: 'nullable', align: 'left', field: 'nullable' },
  { name: 'unique', label: 'unique', align: 'left', field: 'unique' },
  { name: 'comment', label: 'comment', align: 'left', field: 'comment' },
  { name: 'fieldType', label: 'fieldType', align: 'left', field: 'fieldType' },
  { name: 'formType', label: 'formType', align: 'left', field: 'formType' },
  { name: 'tsType', label: 'tsType', align: 'left', field: 'tsType' },
  { name: 'editable', label: 'editable', align: 'left', field: 'editable' },
  { name: 'sortable', label: 'sortable', align: 'left', field: 'sortable' },
  { name: 'queryable', label: 'queryable', align: 'left', field: 'queryable' },
  { name: 'queryType', label: 'queryType', align: 'left', field: 'queryType' }
]

onMounted(async () => {
  await loadFields(props.schemeId, props.tableName)
})

async function loadFields(schemeId: number, tableName: string) {
  loading.value = true

  try {
    const res = await retrieveFields(schemeId, tableName)
    fields.value = res.data
  } catch (error) {
    return Promise.resolve(error)
  } finally {
    loading.value = false
  }
}

defineExpose({
  validate: () => formRef.value?.validate(),
  getFields: () => fields.value
})
</script>