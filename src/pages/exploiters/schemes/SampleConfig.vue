<script lang="ts" setup>
import type { TransferDirection, TransferKey } from 'element-plus'
import { relationSamples, removeModuleSamples, retrieveModuleSamples } from 'src/api/modules'
import type { ModuleSample, Sample } from 'src/types'
import { computed, onMounted, ref, watch } from 'vue'

const props = defineProps<{
  moduleId: number
  tableName: string
  datas: Sample[]
}>()

const emit = defineEmits<{
  (e: 'update:selectedRow', row: Sample | null): void
}>()

const selected = computed<Sample[]>(() =>
  props.datas.flatMap(row =>
    row.id && relations.value.includes(row.id) ? [row] : []
  )
)
const selectedRow = ref<Sample | null>(null)
const relations = ref<Array<number>>([])

const visible = ref<boolean>(false)

onMounted(async () => {
  await loadRelations()
})

watch(
  [() => props.moduleId, () => props.tableName],
  async ([newModuleId, newTableName], [oldModuleId, oldTableName]) => {
    if (newModuleId !== oldModuleId || newTableName !== oldTableName) {
      await loadRelations()
    }
  },
  { immediate: false }
)

async function loadRelations() {
  const res = await retrieveModuleSamples(props.moduleId)
  relations.value = res.data.map((item: ModuleSample) => item.sampleId)
}

function onclick() {
  visible.value = true
}

// 监听选中事件
const handleCurrentChange = (row: Sample | null) => {
  selectedRow.value = row
  emit('update:selectedRow', row)
}

/**
 * transfer事件
 * @param value 数据
 * @param direction 方向
 */
async function handleTransferChange(value: TransferKey[], direction: TransferDirection, movedKeys: TransferKey[]) {
  if (props.moduleId) {
    try {
      if (direction === 'right') {
        await relationSamples(props.moduleId, value as number[])
      } else if (movedKeys.length) {
        await removeModuleSamples(props.moduleId, movedKeys as number[])
      }
    } catch {
      return Promise.resolve()
    }
  }
}
</script>

<template>
  <ElTable ref="moduleRef" :data="selected" highlight-current-row @current-change="handleCurrentChange" height="450">
    <ElTableColumn type="index" :label="$t('label.no')" width="55" />
    <ElTableColumn prop="name" :label="$t('label.name')" />
    <ElTableColumn prop="language" :label="$t('label.language')" />
    <ElTableColumn prop="type" :label="$t('label.type')" />
  </ElTable>
  <ElButton class="mt-4" type="primary" plain style="width: 100%" @click="onclick">
    Add Item
  </ElButton>

  <ElDialog v-model="visible" :title="$t('page.samples')" append-to-body align-center :width="600">
    <ElTransfer v-model="relations" :props="{ key: 'id', label: 'name' }"
      :titles="[$t('label.unselected'), $t('label.selected')]" filterable :data="datas" @change="handleTransferChange"
      class="text-center" />
  </ElDialog>
</template>