<script lang="ts" setup>
import type { ElOption, FormInstance } from 'element-plus'
import { retrieveFields } from 'src/api/schemes'
import { queryTypes } from 'src/constants'
import type { Dictionary, Field } from 'src/types'
import { onMounted, ref } from 'vue'

const props = defineProps<{
  schemeId: number
  tableName: string
  fieldTypeOptions: Dictionary[]
  formTypeOptions: Dictionary[]
  tsTypeOptions: Dictionary[]
}>()
const configLoading = ref<boolean>(false)

const configFormRef = ref<FormInstance>()
const fields = ref<Array<Field>>([])

onMounted(async () => {
  await loadFields(props.schemeId, props.tableName)
})

async function loadFields(schemeId: number, tableName: string) {
  configLoading.value = true

  try {
    const res = await retrieveFields(schemeId, tableName)
    fields.value = res.data
  } catch {
    return Promise.resolve()
  } finally {
    configLoading.value = false
  }
}

defineExpose({
  validate: () => configFormRef.value?.validate(),
  resetFields: () => configFormRef.value?.resetFields(),
  getFields: () => fields.value
})
</script>

<template>
  <ElForm ref="configFormRef" :model="{ fields }" :show-message="false">
    <ElTable v-loading="configLoading" :data="fields" row-key="id" table-layout="auto">
      <ElTableColumn type="index" :label="$t('label.no')" width="55" />
      <ElTableColumn prop="name" :label="$t('label.name')" sortable />
      <ElTableColumn prop="dataType" :label="$t('label.type')" sortable>
        <template #default="scope">
          {{ scope.row.dataType }}{{ scope.row.length ? `(${scope.row.length})` : '' }}
        </template>
      </ElTableColumn>
      <ElTableColumn prop="nullable" :label="$t('label.nullable')" sortable>
        <template #default="scope">
          <ElBadge is-dot :type="scope.row.nullable ? 'info' : 'primary'" class="mr-1" />
          {{ scope.row.nullable ? 'Y' : 'N' }}
        </template>
      </ElTableColumn>
      <ElTableColumn prop="unique" :label="$t('label.unique')" sortable>
        <template #default="scope">
          <ElBadge is-dot :type="scope.row.unique ? 'info' : 'primary'" class="mr-1" />
          {{ scope.row.unique ? 'Y' : 'N' }}
        </template>
      </ElTableColumn>
      <ElTableColumn prop="fieldType" :label="$t('label.fieldType')" sortable>
        <template #default="scope">
          <ElFormItem :prop="'fields.' + scope.$index + '.fieldType'" :rules="[{ required: true, trigger: 'blur' }]">
            <ElSelect v-model="scope.row.fieldType">
              <ElOption v-for="item in fieldTypeOptions" :key="item.id" :label="item.name" :value="item.name" />
            </ElSelect>
          </ElFormItem>
        </template>
      </ElTableColumn>
      <ElTableColumn prop="formType" :label="$t('label.formType')" sortable>
        <template #default="scope">
          <ElFormItem :prop="'fields.' + scope.$index + '.formType'" :rules="[{ required: true, trigger: 'blur' }]">
            <ElSelect v-model="scope.row.formType">
              <ElOption v-for="item in formTypeOptions" :key="item.id" :label="item.name" :value="item.name" />
            </ElSelect>
          </ElFormItem>
        </template>
      </ElTableColumn>
      <ElTableColumn prop="tsType" :label="$t('label.tsType')" sortable>
        <template #default="scope">
          <ElFormItem :prop="'fields.' + scope.$index + '.tsType'" :rules="[{ required: true, trigger: 'blur' }]">
            <ElSelect v-model="scope.row.tsType">
              <ElOption v-for="item in tsTypeOptions" :key="item.id" :label="item.name" :value="item.name" />
            </ElSelect>
          </ElFormItem>
        </template>
      </ElTableColumn>
      <ElTableColumn prop="sortable" :label="$t('label.sortable')" sortable>
        <template #default="scope">
          <ElCheckbox v-model="scope.row.sortable" />
        </template>
      </ElTableColumn>
      <ElTableColumn prop="editable" :label="$t('label.editable')" sortable>
        <template #default="scope">
          <ElFormItem prop="editable">
            <ElCheckbox v-model="scope.row.editable" />
          </ElFormItem>
        </template>
      </ElTableColumn>
      <ElTableColumn prop="queryable" :label="$t('label.queryable')" sortable>
        <template #default="scope">
          <ElCheckbox v-model="scope.row.queryable" />
        </template>
      </ElTableColumn>
      <ElTableColumn prop="queryType" :label="$t('label.queryType')" sortable>
        <template #default="scope">
          <ElSelect v-model="scope.row.queryType" :disabled="!scope.row.queryable">
            <ElOption v-for="(label, value) in queryTypes" :key="value" :label="label" :value="value" />
          </ElSelect>
        </template>
      </ElTableColumn>
    </ElTable>
  </ElForm>
</template>

<style lang="scss" scoped>
.cell {
  .el-form-item {
    margin-bottom: 0px;
  }
}
</style>