<script lang="ts" setup>
import type { TransferDirection, TransferKey } from 'element-plus'
import { relationModules, removeSchemeModules, retrieveSchemeModules } from 'src/api/schemes'
import type { Module, SchemeModule } from 'src/types'
import { computed, onMounted, ref, watch } from 'vue'

const props = defineProps<{
  schemeId: number
  tableName: string
  datas: Module[]
}>()

const emit = defineEmits<{
  (e: 'update:selectedRow', row: Module | null): void
}>()

const selected = computed<Module[]>(() =>
  props.datas.flatMap(row =>
    row.id && relations.value.includes(row.id) ? [row] : []
  )
)
const selectedRow = ref<Module | null>(null)
const relations = ref<Array<number>>([])

const visible = ref<boolean>(false)

onMounted(async () => {
  await loadRelations()
})


watch(() => props.tableName,
  async (newTableName, oldTableName) => {
    if (newTableName !== oldTableName) {
      await loadRelations()
    }
  },
  { immediate: false }
)

async function loadRelations() {
  const res = await retrieveSchemeModules(props.schemeId)
  relations.value = res.data.map((item: SchemeModule) => item.moduleId)
}

function onclick() {
  visible.value = true
}

// 监听选中事件
const handleCurrentChange = (row: Module | null) => {
  selectedRow.value = row
  emit('update:selectedRow', row)
}

/**
 * transfer事件
 * @param value 数据
 * @param direction 方向
 */
async function handleTransferChange(value: TransferKey[], direction: TransferDirection, movedKeys: TransferKey[]) {
  if (props.schemeId) {
    try {
      if (direction === 'right') {
        await relationModules(props.schemeId, value as number[])
      } else if (movedKeys.length) {
        await removeSchemeModules(props.schemeId, movedKeys as number[])
      }
    } catch {
      return Promise.resolve()
    }
  }
}
</script>

<template>
  <ElTable ref="moduleRef" :data="selected" highlight-current-row @current-change="handleCurrentChange" height="450">
    <ElTableColumn type="index" :label="$t('label.no')" width="55" />
    <ElTableColumn prop="name" :label="$t('label.name')" />
    <ElTableColumn show-overflow-tooltip prop="description" :label="$t('label.description')" />
  </ElTable>
  <ElButton class="mt-4" type="primary" plain style="width: 100%" @click="onclick">
    Add Item
  </ElButton>

  <ElDialog v-model="visible" :title="$t('page.modules')" append-to-body align-center :width="600">
    <ElTransfer v-model="relations" :props="{ key: 'id', label: 'name' }"
      :titles="[$t('label.unselected'), $t('label.selected')]" filterable :data="datas" @change="handleTransferChange"
      class="text-center" />
  </ElDialog>
</template>