<script lang="ts" setup>
import type { TransferDirection, TransferKey } from 'element-plus'
import { relationFragments, removeSampleFragments, retrieveSampleFragments } from 'src/api/samples'
import type { Fragment, SampleFragment } from 'src/types'
import { computed, onMounted, ref, watch } from 'vue'

const props = defineProps<{
  sampleId: number
  tableName: string
  datas: Fragment[]
}>()


const selected = computed<Fragment[]>(() =>
  props.datas.flatMap(row =>
    row.id && relations.value.includes(row.id) ? [row] : []
  )
)
const relations = ref<Array<number>>([])

const visible = ref<boolean>(false)

onMounted(async () => {
  await loadRelations()
})

watch(
  [() => props.sampleId, () => props.tableName],
  async ([newSample, newTableName], [oldSampleId, oldTableName]) => {
    if (newSample !== oldSampleId || newTableName !== oldTableName) {
      await loadRelations()
    }
  },
  { immediate: false }
)

async function loadRelations() {
  const res = await retrieveSampleFragments(props.sampleId)
  relations.value = res.data.map((item: SampleFragment) => item.fragmentId)
}

function onclick() {
  visible.value = true
}

/**
 * transfer事件
 * @param value 数据
 * @param direction 方向
 */
async function handleTransferChange(value: TransferKey[], direction: TransferDirection, movedKeys: TransferKey[]) {
  if (props.sampleId) {
    try {
      if (direction === 'right') {
        await relationFragments(props.sampleId, value as number[])
      } else if (movedKeys.length) {
        await removeSampleFragments(props.sampleId, movedKeys as number[])
      }
    } catch {
      return Promise.resolve()
    }
  }
}
</script>

<template>
  <ElTable ref="moduleRef" :data="selected" height="450">
    <ElTableColumn type="index" :label="$t('label.no')" width="55" />
    <ElTableColumn prop="name" :label="$t('label.name')" />
    <ElTableColumn prop="language" :label="$t('label.language')" />
  </ElTable>
  <ElButton class="mt-4" type="primary" plain style="width: 100%" @click="onclick">
    Add Item
  </ElButton>

  <ElDialog v-model="visible" :title="$t('page.fragments')" append-to-body align-center :width="600">
    <ElTransfer v-model="relations" :props="{ key: 'id', label: 'name' }"
      :titles="[$t('label.unselected'), $t('label.selected')]" filterable :data="datas" @change="handleTransferChange"
      class="text-center" />
  </ElDialog>
</template>