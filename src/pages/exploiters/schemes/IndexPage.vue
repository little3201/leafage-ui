<template>
  <q-page padding>
    <q-dialog v-model="visible" persistent>
      <q-card style="min-width: 25em">
        <q-form @submit="onSubmit">
          <q-card-section>
            <div class="text-h6">{{ $t('page.schemes') }}</div>
          </q-card-section>

          <q-card-section>
            <div class="row q-col-gutter-x-md">
              <q-select outlined dense options-dense v-model="form.connectionId" option-value="name" option-label="name"
                :options="tables" emit-value :label="$t('label.name')" class="col-6"
                :rules="[val => val && val.length > 0 || $t('placeholder.selectText')]" />
              <q-input outlined dense v-model="form.module" :label="$t('label.prefix')" class="col-6" />
            </div>

            <q-input outlined dense v-model="form.packageName" :label="$t('label.packageName')" lazy-rules
              :rules="[val => val && val.length > 0 || $t('placeholder.inputText')]" />
          </q-card-section>

          <q-card-actions align="right">
            <q-btn title="cancel" type="reset" unelevated :label="$t('action.cancel')" v-close-popup />
            <q-btn title="submit" type="submit" flat :label="$t('action.submit')" color="primary" />
          </q-card-actions>
        </q-form>
      </q-card>
    </q-dialog>

    <q-table ref="tableRef" flat :title="$t('page.schemes')" :rows="rows" :columns="columns" row-key="id"
      :loading="loading" v-model:pagination="pagination" :filter="filter" binary-state-sort @request="onRequest"
      class="full-width">
      <template v-slot:top-right>
        <q-input dense debounce="300" v-model="filter.title" placeholder="Search">
          <template v-slot:append>
            <q-icon name="sym_r_search" />
          </template>
        </q-input>
        <q-btn title="create" round padding="xs" class="q-mx-sm" color="primary" :disable="loading" icon="sym_r_add"
          @click="saveRow()" />
        <q-btn title="refresh" round padding="xs" flat color="primary" :disable="loading" icon="sym_r_refresh"
          @click="refresh" />
        <q-btn title="import" round padding="xs" flat color="primary" class="q-mx-sm" :disable="loading"
          icon="sym_r_database_upload" @click="importRow" />
        <q-btn title="export" round padding="xs" flat color="primary" icon="sym_r_file_export"
          @click="exportTable(columns, rows)" />
      </template>

      <template v-slot:header="props">
        <q-tr :props="props">
          <q-th v-for="col in props.cols" :key="col.name" :props="props">
            {{ $t(`label.${col.label}`) }}
          </q-th>
        </q-tr>
      </template>

      <template v-slot:body-cell-module="props">
        <q-td :props="props">
          <q-btn title="preview" flat rounded no-caps color="primary" @click="previewRow(props.row.id)">
            {{ props.row.module }}
          </q-btn>
        </q-td>
      </template>
      <template v-slot:body-cell-tables="props">
        <q-td :props="props">
          {{ props.row.tables.join(', ') }}
        </q-td>
      </template>
      <template v-slot:body-cell-id="props">
        <q-td :props="props">
          <q-btn title="modify" padding="xs" flat round color="primary" icon="sym_r_edit"
            @click="saveRow(props.row.id)" />
          <q-btn title="config" padding="xs" flat round color="positive" icon="sym_r_rule_settings"
            @click="configRow(props.row)" class="q-mx-sm" />
          <q-btn title="config" padding="xs" flat round color="primary" icon="sym_r_sync" @click="syncRow(props.row.id)"
            class="q-mx-sm" />
          <q-btn title="delete" padding="xs" flat round color="negative" icon="sym_r_delete"
            @click="removeRow(props.row.id)" />
        </q-td>
      </template>
    </q-table>

    <!-- config -->
    <q-dialog v-model="configVisible">
      <q-card style="max-width: 100em;">
        <q-card-section class="flex items-center q-pb-none">
          <div class="text-h6">{{ $t('action.config') }}</div>
          <q-space />
          <q-btn icon="sym_r_close" flat round dense v-close-popup />
        </q-card-section>

        <q-card-section style="max-height: 50vh" class="scroll">
          <q-stepper flat v-model="step" ref="stepper" alternative-labels animated>
            <q-step :name="1" title="Config Modules" icon="sym_r_settings" :done="step > 1">
              <q-item tag="label" v-ripple v-for="(item, index) in modules" :key="index">
                <q-item-section side top>
                  <q-checkbox v-model="relations" :val="item.id" />
                </q-item-section>

                <q-item-section>
                  <q-item-label>{{ item.name }}</q-item-label>
                  <q-item-label caption>
                    {{ item.description }}
                  </q-item-label>
                </q-item-section>

                <q-item-section side>
                  <div class="text-grey-8 q-gutter-xs">
                    <q-btn class="gt-xs" size="12px" flat dense round icon="sym_r_delete" />
                    <q-btn class="gt-xs" size="12px" flat dense round icon="sym_r_done" />
                    <q-btn size="12px" flat dense round icon="sym_r_more_vert" />
                  </div>
                </q-item-section>
              </q-item>
            </q-step>

            <q-step :name="2" title="Config Samples" icon="sym_r_create_new_folder" :done="step > 2">
              <q-tabs v-model="activeTabName" align="justify">
                <q-tab v-for="(table, index) in form.tables" :key="index" :label="table" :name="table">
                </q-tab>
              </q-tabs>
              <q-tab-panels v-model="activeTabName" animated>
                <q-tab-panel v-for="(table, index) in form.tables" :key="index" :name="table">
                  <q-item tag="label" v-ripple v-for="(item, index) in samples" :key="index">
                    <q-item-section>
                      <q-item-label>{{ item.name }}</q-item-label>
                      <q-item-label caption>
                        {{ item.language }}
                      </q-item-label>
                    </q-item-section>

                    <q-item-section side>
                      <div class="text-grey-8 q-gutter-xs">
                        <q-btn class="gt-xs" size="12px" flat dense round icon="sym_r_delete" />
                        <q-btn class="gt-xs" size="12px" flat dense round icon="sym_r_done" />
                        <q-btn size="12px" flat dense round icon="sym_r_more_vert" />
                      </div>
                    </q-item-section>
                  </q-item>
                </q-tab-panel>
              </q-tab-panels>
            </q-step>

            <q-step :name="3" title="Config Fields" icon="sym_r_assignment">
              <q-tabs v-model="activeTabName" align="justify">
                <q-tab v-for="(table, index) in form.tables" :key="index" :label="table" :name="table">
                </q-tab>
              </q-tabs>
              <q-tab-panels v-model="activeTabName" animated>
                <q-tab-panel v-for="(table, index) in form.tables" :key="index" :name="table">
                  <FieldForm v-if="form.id" ref="FieldFormRef" :scheme-id="form.id" :table-name="table"
                    :field-type-options="fieldTypeOptions" :form-type-options="formTypeOptions"
                    :ts-type-options="tsTypeOptions" />
                </q-tab-panel>
              </q-tab-panels>
            </q-step>
          </q-stepper>
        </q-card-section>

        <q-card-actions align="right">
          <q-btn v-if="step > 1" flat @click="stepper.previous()" color="primary" label="Back" />
          <q-btn v-if="step < 3" flat color="primary" @click="stepper.next()" label="Continue" />
          <q-btn v-if="step == 3" type="submit" flat @click="configSubmit(form)" :label="$t('action.submit')" />
        </q-card-actions>
      </q-card>
    </q-dialog>

    <!-- preview -->
    <q-dialog v-model="previewVisible">
      <q-card class="full-width" style="max-width: 80em;">
        <q-card-section class="flex items-center q-pb-none">
          <div class="text-h6">{{ $t('action.preview') }}</div>
          <q-space />
          <q-btn icon="sym_r_close" flat round dense v-close-popup />
        </q-card-section>
        <q-card-section class="row" style="flex: 1;">
          <q-tree ref="treeRef" :nodes="treeData" node-key="name" label-key="name" selected-color="primary"
            v-model:selected="selectedKey" @update:selected="onNodeSelected" default-expand-all style="height: 600px;"
            class="col-3 scroll" />

          <CodeRender v-if="selectedFile" :content="selectedFile.body" :language="selectedFile.language?.toLowerCase()"
            style="height: 600px;" class="col-9 scroll" />
        </q-card-section>
      </q-card>
    </q-dialog>

  </q-page>
</template>

<script setup lang="ts">
import CodeRender from 'components/CodeRender.vue'
import type { QTable, QTableColumn, QTableProps, QTree } from 'quasar'
import { retrieveTables } from 'src/api/connections'
import { retrieveDictionarySubset } from 'src/api/dictionaries'
import { retrieveModules } from 'src/api/modules'
import {
  configFields,
  createScheme,
  fetchScheme,
  modifyScheme,
  previewScheme,
  removeScheme,
  retrieveSchemeModules,
  retrieveSchemes,
  syncFields
} from 'src/api/schemes'
import type { Dictionary, Module, Sample, Scheme, SchemeModule } from 'src/types'
import { exportTable } from 'src/utils'
import { computed, onMounted, ref } from 'vue'
import FieldForm from './FieldForm.vue'


const visible = ref<boolean>(false)
const importVisible = ref<boolean>(false)
const previewVisible = ref<boolean>(false)
const configVisible = ref<boolean>(false)

const tableRef = ref<QTable>()
const rows = ref<Array<Scheme>>([])
const filter = ref({
  connectionId: null,
  title: ''
})
const loading = ref<boolean>(false)
const configLoading = ref<boolean>(false)
const syncLoading = ref<boolean>(false)

const tables = ref<Array<string>>([])
const fieldTypeOptions = ref<Array<Dictionary>>([])
const formTypeOptions = ref<Array<Dictionary>>([])
const tsTypeOptions = ref<Array<Dictionary>>([])

const FieldFormRef = ref()
const activeTabName = ref('')
const modules = ref<Array<Module>>([])
const relations = ref<Array<number>>([])
const samples = ref<Array<Sample>>([])
const step = ref(1)
const stepper = ref()

const treeRef = ref<InstanceType<typeof QTree> | null>(null)
const selectedKey = ref<string>('')
const selectedFile = ref<Sample.Rendered | null>(null)
const renderedSamples = ref<Array<Sample.TreeNode>>([])

const initialValues: Scheme = {
  id: null,
  module: '',
  connectionId: null,
  scope: 'PARTIAL',
  packageName: '',
  tables: []
}
const form = ref<Scheme>({ ...initialValues })

const pagination = ref({
  sortBy: 'id',
  descending: true,
  page: 1,
  rowsPerPage: 7,
  rowsNumber: 0
})

const columns: QTableColumn<Scheme>[] = [
  { name: 'module', label: 'module', align: 'left', field: 'module', sortable: true },
  { name: 'database', label: 'database', align: 'left', field: 'connectionId' },
  { name: 'scope', label: 'scope', align: 'left', field: 'scope' },
  { name: 'packageName', label: 'packageName', align: 'left', field: 'packageName' },
  { name: 'tables', label: 'tables', align: 'left', field: 'tables' },
  { name: 'id', label: 'actions', field: 'id' }
]


onMounted(async () => {
  refresh()

  const moduleRes = await retrieveModules({ page: 1, size: 99 })
  modules.value = moduleRes.data.content

  const fieldTypeRes = await retrieveDictionarySubset(200)
  fieldTypeOptions.value = fieldTypeRes.data

  const formTypeRes = await retrieveDictionarySubset(300)
  formTypeOptions.value = formTypeRes.data

  const tsTypeRes = await retrieveDictionarySubset(400)
  tsTypeOptions.value = tsTypeRes.data
})

/**
 * 查询列表
 */
async function onRequest(props: Parameters<NonNullable<QTableProps['onRequest']>>[0]) {
  loading.value = true

  const { page, rowsPerPage, sortBy, descending } = props.pagination
  const filter = props.filter

  const params = { page, size: rowsPerPage, sortBy, descending }

  try {
    const res = await retrieveSchemes({ ...params }, filter)
    pagination.value.page = page
    pagination.value.rowsPerPage = rowsPerPage
    pagination.value.sortBy = sortBy
    pagination.value.descending = descending

    rows.value = res.data.content
    pagination.value.rowsNumber = res.data.totalElements
  } catch (error) {
    return Promise.resolve(error)
  } finally {
    loading.value = false
  }
}

function refresh() {
  tableRef.value?.requestServerInteraction()
}

async function saveRow(row?: Scheme) {
  form.value = { ...initialValues }
  try {
    if (row && row.id) {
      const res = await fetchScheme(row.id)
      form.value = res.data
    }
    if (row && row.connectionId) {
      const tableRes = await retrieveTables(row.connectionId)
      tables.value = tableRes.data
    }
  } catch (error) {
    return Promise.resolve(error)
  }
  visible.value = true
}

function importRow() {
  importVisible.value = true
}

/**
   * config
   * @param row the row data
   */
async function configRow(row: Scheme) {
  configVisible.value = true

  form.value = { ...row }
  activeTabName.value = row.tables[0] || ''

  if (row.id) {
    const res = await retrieveSchemeModules(row.id)
    relations.value = res.data.map((item: SchemeModule) => item.moduleId)
  }
}

async function previewRow(id: number) {
  try {
    const res = await previewScheme(id)
    renderedSamples.value = res.data
  } catch (error) {
    return Promise.resolve(error)
  }
  previewVisible.value = true
}

async function syncRow(id: number) {
  syncLoading.value = true
  try {
    await syncFields(id)
    refresh()
  } catch (error) {
    return Promise.resolve(error)
  } finally {
    syncLoading.value = false
  }
}

async function removeRow(id: number) {
  loading.value = true
  try {
    await removeScheme(id)
    refresh()
  } catch (error) {
    return Promise.resolve(error)
  } finally {
    loading.value = false
  }
}

async function onSubmit() {
  try {
    if (form.value.id) {
      await modifyScheme(form.value.id, form.value)
    } else {
      await createScheme(form.value)
    }
    refresh()
    visible.value = false
  } catch (error) {
    return Promise.resolve(error)
  }
}

/**
   * config submit
   */
async function configSubmit(form: Scheme) {
  if (!form || !activeTabName.value) return
  const activeIndex = form.tables.indexOf(activeTabName.value)
  const formPage = FieldFormRef.value[activeIndex]
  if (!formPage) return

  try {
    const valid = await formPage.validate()
    if (valid) {
      configLoading.value = true
      const fields = formPage.getFields()
      if (form.id && fields.length) {
        await configFields(form.id, activeTabName.value, fields)
      }
    }
  } catch (error) {
    return Promise.resolve(error)
  } finally { configLoading.value = false }
}

/**
 * selected node
 * @param key node key
 */
function onNodeSelected(key: string | null) {
  const node = treeRef.value?.getNodeByKey(key)
  if (node) {
    selectedFile.value = node.file
  }
}

/**
 * 计算树形数据
 */
const treeData = computed<Sample.TreeNode[]>(() => {
  const backendRoot: Sample.TreeNode = {
    name: 'server',
    filePath: 'backend',
    children: []
  }

  const frontendRoot: Sample.TreeNode = {
    name: 'ui',
    filePath: 'frontend',
    children: []
  }

  renderedSamples.value.forEach((rendered) => {
    if (!rendered.filePath?.trim()) return

    const isBackend = rendered.filePath.startsWith('src/main')
    const root = isBackend ? backendRoot : frontendRoot

    const dirParts = rendered.filePath.split('/').filter(Boolean)  // 纯粹的目录路径段，如 ['src', 'api']

    if (dirParts.length === 0) return

    let current: Sample.TreeNode = root

    // 第一步：构建所有目录层级（包括最后一级文件夹，如 api、vo）
    dirParts.forEach((part, index) => {
      const currentPath = dirParts.slice(0, index + 1).join('/')

      let folderNode = current.children!.find(n => n.filePath === currentPath)

      if (!folderNode) {
        folderNode = {
          name: part,                    // 文件夹显示路径段，如 "api"
          filePath: currentPath,
          children: []
        }
        current.children!.push(folderNode)
      }

      current = folderNode
    })

    // 第二步：将文件节点添加到最后一级文件夹下
    const fileNode: Sample.TreeNode = {
      name: rendered.name,               // 真实文件名，如 "access-logs.ts"
      filePath: rendered.filePath + '/' + rendered.name,  // 可选：完整路径用于唯一标识
      file: rendered
    }

    // 避免重复添加同一文件
    const exists = current.children!.some(n => n.file?.name === rendered.name)
    if (!exists) {
      current.children!.push(fileNode)
    }
  })

  const result: Sample.TreeNode[] = []
  if (backendRoot.children!.length > 0) result.push(backendRoot)
  if (frontendRoot.children!.length > 0) result.push(frontendRoot)

  // 排序
  const sortNodes = (nodes: Sample.TreeNode[]) => {
    nodes.sort((a, b) => {
      const aIsFolder = !!a.children
      const bIsFolder = !!b.children
      if (aIsFolder && !bIsFolder) return -1
      if (!aIsFolder && bIsFolder) return 1
      return a.name.localeCompare(b.name)
    })
    nodes.forEach(n => n.children && sortNodes(n.children))
  }

  result.forEach(r => sortNodes(r.children ?? []))

  return result
})
</script>
